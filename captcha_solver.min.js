const CHARS_MAP="3456789ABCDEHJKMNPRSTUVWXY",BLANK_INDEX=26,MODEL_CONFIG={imageWidth:200,imageHeight:50,numTimesteps:50,numClasses:27};let ctcSession=null,isInitialized=!1,initializationError=null,currentSettings={modelPath:""};async function initializeSolver(e=null){if(isInitialized)return console.log("Solver: Already initialized"),!0;try{if(console.log("Solver: Initializing ONNX Runtime Web (CTC mode)..."),"undefined"==typeof ort)throw new Error("ONNX Runtime Web not loaded. Please include ort.min.js");if("undefined"!=typeof chrome&&chrome.storage)try{const e=await new Promise(e=>{chrome.storage.local.get({modelPath:""},e)});currentSettings=e,console.log("Solver: Settings loaded:",currentSettings)}catch(e){console.warn("Solver: Could not load settings, using defaults")}const o=window.__APP_EXTENSION_URL__||("undefined"!=typeof chrome&&chrome.runtime&&chrome.runtime.getURL?chrome.runtime.getURL(""):"./"),t=e||currentSettings.modelPath||o+"captcha-model/";console.log("Solver: Extension root:",o),console.log("Solver: Using model path:",t),ort.env.wasm.wasmPaths=o,ort.env.wasm.numThreads=1,ort.env.wasm.simd=!1;const n=t+(t.endsWith("/")?"":"/")+"captcha_ctc.onnx";return console.log("Solver: Loading CTC model...",n),ctcSession=await ort.InferenceSession.create(n,{executionProviders:["wasm"]}),console.log("Solver: ✅ CTC model loaded"),console.log("Solver: Input names:",ctcSession.inputNames),console.log("Solver: Output names:",ctcSession.outputNames),isInitialized=!0,initializationError=null,console.log("Solver: ✅ Initialization complete (CTC mode)"),!0}catch(e){return console.error("Solver: ❌ Initialization failed:",e),initializationError=e&&e.message?e.message:String(e),notifyUser("error","CAPTCHA Solver gagal dimuat: "+initializationError),!1}}function notifyUser(e,o){let t=document.getElementById("solver-notification");t||(t=document.createElement("div"),t.id="solver-notification",t.style.cssText="\n      position: fixed;\n      top: 10px;\n      right: 10px;\n      padding: 12px 20px;\n      border-radius: 5px;\n      z-index: 999999;\n      font-family: sans-serif;\n      font-size: 14px;\n      box-shadow: 0 2px 10px rgba(0,0,0,0.2);\n      transition: opacity 0.3s;\n    ",document.body.appendChild(t)),"error"===e?(t.style.backgroundColor="#f8d7da",t.style.color="#721c24",t.style.border="1px solid #f5c6cb"):"success"===e?(t.style.backgroundColor="#d4edda",t.style.color="#155724",t.style.border="1px solid #c3e6cb"):(t.style.backgroundColor="#fff3cd",t.style.color="#856404",t.style.border="1px solid #ffeeba"),t.textContent=o,t.style.display="block",t.style.opacity="1","error"!==e&&setTimeout(()=>{t.style.opacity="0",setTimeout(()=>{t.style.display="none"},300)},5e3)}function imageToTensor(e){const o=document.createElement("canvas");o.width=MODEL_CONFIG.imageWidth,o.height=MODEL_CONFIG.imageHeight;const t=o.getContext("2d");t.drawImage(e,0,0,MODEL_CONFIG.imageWidth,MODEL_CONFIG.imageHeight);const n=t.getImageData(0,0,MODEL_CONFIG.imageWidth,MODEL_CONFIG.imageHeight).data,i=new Float32Array(MODEL_CONFIG.imageHeight*MODEL_CONFIG.imageWidth);for(let e=0;e<MODEL_CONFIG.imageHeight*MODEL_CONFIG.imageWidth;e++){const o=(.299*n[4*e]+.587*n[4*e+1]+.114*n[4*e+2])/255;i[e]=o}return i}function ctcGreedyDecode(e){const o=MODEL_CONFIG.numTimesteps,t=MODEL_CONFIG.numClasses,n=[];let i=-1;for(let r=0;r<o;r++){let o=0,a=e[r*t];for(let n=1;n<t;n++){const i=e[r*t+n];i>a&&(a=i,o=n)}26!==o&&o!==i&&n.push(o),i=o}return n.map(e=>e>=0&&e<26?CHARS_MAP[e]:"?").join("")}async function runCTCInference(e){if(!ctcSession)throw new Error("CTC model not initialized");const o=new ort.Tensor("float32",e,[1,MODEL_CONFIG.imageHeight,MODEL_CONFIG.imageWidth,1]),t={};t[ctcSession.inputNames[0]]=o;return ctcGreedyDecode((await ctcSession.run(t))[ctcSession.outputNames[0]].data)}async function solveCaptcha(e){if(!isInitialized)throw new Error("Solver not initialized. Call initializeSolver() first.");console.log("Solver: Starting CTC CAPTCHA prediction...");try{const o=imageToTensor(e);console.log("Solver: Running CTC inference...");const t=await runCTCInference(o);return console.log("Solver: ✅ Prediction:",t),t}catch(e){throw console.error("Solver: ❌ Prediction failed:",e),e}}async function solveCaptchaFromUrl(e){return new Promise((o,t)=>{const n=new Image;n.crossOrigin="anonymous",n.onload=async()=>{try{const e=await solveCaptcha(n);o(e)}catch(e){t(e)}},n.onerror=()=>t(new Error("Failed to load image")),n.src=e})}async function solveCaptchaFromBase64(e){let o=e;return e.startsWith("data:")||(o="data:image/png;base64,"+e),solveCaptchaFromUrl(o)}"undefined"!=typeof window&&(window.CaptchaSolver={initialize:initializeSolver,solve:solveCaptcha,solveFromUrl:solveCaptchaFromUrl,solveFromBase64:solveCaptchaFromBase64,isReady:()=>isInitialized,getError:()=>initializationError,notifyUser:notifyUser,CHARS:CHARS_MAP,BLANK_INDEX:26});